<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sense360 ESP32 Installer</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Sense360 ESP32 Installer</h1>
            <p>Flash Sense360 v2.0.0 firmware to ESP32 devices</p>
        </header>

        <main>
            <div class="intro-section">
                <h2>Getting Started</h2>
                <p>Connect your ESP32 device to your computer using a USB cable. Make sure you're using Chrome or Edge browser with HTTPS enabled.</p>
                <p>This installer will flash the Sense360 v2.0.0 firmware to your ESP32 device. Click the "Install Sense360" button below to begin.</p>
            </div>

            <div class="install-section">
                <h2>Install Sense360 Firmware</h2>
                <div class="firmware-selection">
                    <h3>Firmware Selection</h3>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="device-family">Device Family</label>
                            <select id="device-family" class="filter-select">
                                <option value="all">All Families</option>
                                <option value="envmonitor">Envmonitor</option>
<option value="generic_env_monitor">Generic_Env_Monitor</option>
<option value="genericenvmonitor">Genericenvmonitor</option>
<option value="temperaturesensor">Temperaturesensor</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="release-type">Release Type</label>
                            <select id="release-type" class="filter-select">
                                <option value="all">All Types</option>
                                <option value="beta">Beta</option>
<option value="stable">Stable</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="firmware-options">
                        <div class="firmware-option" data-module="genericenvmonitor" data-release="stable">
                            <input type="radio" id="genericenvmonitor-stable" name="firmware" value="genericenvmonitor-stable" checked>
                            <label for="genericenvmonitor-stable">
                                <div class="option-header">
                                    <strong>GenericEnvMonitor (ESP32)</strong>
                                    <span class="version-badge stable">Stable</span>
                                </div>
                                <div class="option-meta">
                                    <span class="release-date">Updated: 2025.07.11</span>
                                </div>
                                <div class="option-description">
                                    Firmware for GenericEnvMonitor devices using ESP32 chip family.
                                </div>
                                <div class="option-features">
                                    <span class="feature">ESP32</span> <span class="feature">Monitoring</span> <span class="feature">Wireless</span>
                                </div>
                            </label>
                        </div>

                        <div class="firmware-option" data-module="envmonitor" data-release="stable">
                            <input type="radio" id="envmonitor-stable" name="firmware" value="envmonitor-stable" >
                            <label for="envmonitor-stable">
                                <div class="option-header">
                                    <strong>EnvMonitor (ESP32S3)</strong>
                                    <span class="version-badge stable">Stable</span>
                                </div>
                                <div class="option-meta">
                                    <span class="release-date">Updated: 2025.07.11</span>
                                </div>
                                <div class="option-description">
                                    Firmware for EnvMonitor devices using ESP32-S3 chip family.
                                </div>
                                <div class="option-features">
                                    <span class="feature">ESP32-S3</span> <span class="feature">Monitoring</span> <span class="feature">Wireless</span>
                                </div>
                            </label>
                        </div>

                        <div class="firmware-option" data-module="temperaturesensor" data-release="beta">
                            <input type="radio" id="temperaturesensor-beta" name="firmware" value="temperaturesensor-beta" >
                            <label for="temperaturesensor-beta">
                                <div class="option-header">
                                    <strong>TemperatureSensor (ESP32) - Beta</strong>
                                    <span class="version-badge beta">Beta</span>
                                </div>
                                <div class="option-meta">
                                    <span class="release-date">Updated: 2025.07.11</span>
                                </div>
                                <div class="option-description">
                                    Firmware for TemperatureSensor devices using ESP32 chip family.
                                </div>
                                <div class="option-features">
                                    <span class="feature">ESP32</span> <span class="feature">Multi-Sensor</span> <span class="feature">Temperature</span> <span class="feature">Wireless</span>
                                </div>
                            </label>
                        </div>

                        <div class="firmware-option" data-module="generic_env_monitor" data-release="stable">
                            <input type="radio" id="generic_env_monitor-stable" name="firmware" value="generic_env_monitor-stable" >
                            <label for="generic_env_monitor-stable">
                                <div class="option-header">
                                    <strong>generic_env_monitor (Legacy)</strong>
                                    <span class="version-badge stable">Stable</span>
                                </div>
                                <div class="option-meta">
                                    <span class="release-date">Updated: 2025.07.11</span>
                                </div>
                                <div class="option-description">
                                    Firmware for generic_env_monitor devices using ESP32-S3 chip family.
                                </div>
                                <div class="option-features">
                                    <span class="feature">ESP32-S3</span> <span class="feature">Monitoring</span> <span class="feature">Wireless</span>
                                </div>
                            </label>
                        </div>
                    </div>
                                <div class="option-meta">
                                    <span class="release-date">Released: Jul 11, 2025</span>
                                </div>
                                <div class="option-description">
                                    Comprehensive environmental monitoring with multiple sensor support and wireless connectivity.
                                </div>
                                <div class="option-features">
                                    <span class="feature">Multi-Sensor</span>
                                    <span class="feature">Wireless</span>
                                    <span class="feature">ESP32-S3</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="install-container">
                    <esp-web-install-button manifest="./manifest.json" id="install-button">
                        <button type="button" class="btn-primary" slot="activate">Install Sense360</button>
                        <span slot="not-allowed">
                            <div class="alert alert-danger">
                                <h3>‚ö†Ô∏è Not Allowed</h3>
                                <p>Flashing is only supported from localhost or from a secure (HTTPS) website.</p>
                            </div>
                        </span>
                        <span slot="notsupported">
                            <div class="alert alert-danger">
                                <h3>‚ö†Ô∏è Browser Not Supported</h3>
                                <p>ESP Web Tools requires Chrome or Edge browser. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility" target="_blank">Check browser compatibility</a></p>
                            </div>
                        </span>
                    </esp-web-install-button>
                </div>
            </div>

            <div class="features-section">
                <h2>Features</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <h3>üîå Easy Connection</h3>
                        <p>Connect ESP32 devices directly via USB using the Web Serial API</p>
                    </div>
                    <div class="feature-card">
                        <h3>‚ö° Fast Flashing</h3>
                        <p>Automatic chip detection and optimized firmware flashing</p>
                    </div>
                    <div class="feature-card">
                        <h3>üì± Wi-Fi Setup</h3>
                        <p>Configure Wi-Fi settings using Improv protocol after flashing</p>
                    </div>
                    <div class="feature-card">
                        <h3>üîç Serial Monitor</h3>
                        <p>Real-time serial output monitoring and command interface</p>
                    </div>
                </div>
            </div>

            <div class="troubleshooting-section">
                <h2>Troubleshooting</h2>
                <div class="troubleshooting-content">
                    <h3>Device Not Detected?</h3>
                    <ul>
                        <li>Make sure your ESP32 is connected via USB</li>
                        <li>Check that you're using Chrome or Edge browser</li>
                        <li>Verify you're accessing the site via HTTPS</li>
                        <li>Try a different USB cable or port</li>
                        <li>On Windows, ensure proper drivers are installed</li>
                    </ul>
                    
                    <h3>Flashing Failed?</h3>
                    <ul>
                        <li>Hold the BOOT button while connecting (if available)</li>
                        <li>Try resetting the device before flashing</li>
                        <li>Ensure no other applications are using the serial port</li>
                        <li>Check that the firmware file is compatible with your chip</li>
                    </ul>
                </div>
            </div>
        </main>

        <footer>
            <p>
                <a href="https://github.com/esphome/esp-web-tools" target="_blank">Powered by ESP Web Tools</a> | 
                <a href="https://github.com/your-repo/esp32-flasher" target="_blank">View Source</a>
            </p>
        </footer>
    </div>
    
    <script>
        // Handle firmware selection and filtering
        const firmwareOptions = document.querySelectorAll('input[name="firmware"]');
        const installButton = document.getElementById('install-button');
        const deviceFamilySelect = document.getElementById('device-family');
        const releaseTypeSelect = document.getElementById('release-type');
        const firmwareOptionElements = document.querySelectorAll('.firmware-option');
        
        // Map firmware selections to different manifests
        const manifestMap = {
            'envmonitor-stable': './manifest-env-monitor.json'
        };
        
        function updateManifest() {
            const selectedFirmware = document.querySelector('input[name="firmware"]:checked');
            if (selectedFirmware && installButton) {
                const manifestPath = manifestMap[selectedFirmware.value] || './manifest.json';
                installButton.setAttribute('manifest', manifestPath);
            }
        }
        
        function filterFirmwareOptions() {
            const selectedFamily = deviceFamilySelect.value;
            const selectedType = releaseTypeSelect.value;
            
            let visibleCount = 0;
            
            firmwareOptionElements.forEach(option => {
                const module = option.dataset.module;
                const release = option.dataset.release;
                
                const familyMatch = selectedFamily === 'all' || module === selectedFamily;
                const typeMatch = selectedType === 'all' || release === selectedType;
                
                if (familyMatch && typeMatch) {
                    option.style.display = 'block';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                    // Uncheck hidden options
                    const radio = option.querySelector('input[type="radio"]');
                    if (radio && radio.checked) {
                        radio.checked = false;
                    }
                }
            });
            
            // Select first visible option if none selected
            const checkedOption = document.querySelector('input[name="firmware"]:checked');
            if (!checkedOption && visibleCount > 0) {
                const firstVisible = document.querySelector('.firmware-option[style="display: block;"] input[type="radio"], .firmware-option:not([style*="none"]) input[type="radio"]');
                if (firstVisible) {
                    firstVisible.checked = true;
                }
            }
            
            updateManifest();
        }
        
        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to radio buttons
            firmwareOptions.forEach(option => {
                option.addEventListener('change', updateManifest);
            });
            
            // Add event listeners to filter selects
            if (deviceFamilySelect) {
                deviceFamilySelect.addEventListener('change', filterFirmwareOptions);
            }
            if (releaseTypeSelect) {
                releaseTypeSelect.addEventListener('change', filterFirmwareOptions);
            }
            
            // Set initial state
            filterFirmwareOptions();
        });
    </script>
</body>
</html>
