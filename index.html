<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sense360 Firmware Configuration Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/wizard-style.css?v=1753432000">
    <script type="module" src="https://unpkg.com/esp-web-tools@9/dist/web/install-button.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="sense360-logo-new.png" alt="Sense360 Logo" class="logo">
                <div class="header-text">
                    <h1>Sense360 Firmware Configuration Tool</h1>
                    <p class="subtitle">Configure and download the correct firmware for your modular hardware</p>
                </div>
            </div>
        </header>

        <div class="wizard-container">
            <!-- Progress Indicator -->
            <div class="progress-bar">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Mounting</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Power</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Modules</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Review</div>
                </div>
            </div>

            <!-- Step 1: Mounting Type -->
            <div class="wizard-step active" id="step-1">
                <h2>Step 1: Where is this unit being installed?</h2>
                <div class="option-grid">
                    <label class="option-card">
                        <input type="radio" name="mounting" value="wall">
                        <div class="option-content">
                            <div class="option-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="4" width="16" height="16" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="8" cy="8" r="1" fill="#1a73e8"/>
                                    <circle cx="16" cy="8" r="1" fill="#1a73e8"/>
                                    <circle cx="8" cy="16" r="1" fill="#1a73e8"/>
                                    <circle cx="16" cy="16" r="1" fill="#1a73e8"/>
                                </svg>
                            </div>
                            <div class="option-title">Wall Mount</div>
                            <div class="option-description">Standard wall installation with full module support</div>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="mounting" value="ceiling">
                        <div class="option-content">
                            <div class="option-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L3 7V12H21V7L12 2Z" stroke="#1a73e8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="9" r="2" fill="#1a73e8"/>
                                    <line x1="12" y1="12" x2="12" y2="16" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="option-title">Ceiling Mount</div>
                            <div class="option-description">Ceiling installation (Fan Module not available)</div>
                        </div>
                    </label>
                </div>
                <div class="wizard-actions">
                    <button class="btn btn-primary btn-next" onclick="nextStep()" disabled>Next</button>
                </div>
            </div>

            <!-- Step 2: Power Option -->
            <div class="wizard-step" id="step-2">
                <h2>Step 2: Select Power Option</h2>
                <div class="option-grid">
                    <label class="option-card">
                        <input type="radio" name="power" value="usb">
                        <div class="option-content">
                            <div class="option-title">USB Power</div>
                            <div class="option-description">Standard USB-C power connection</div>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="power" value="poe">
                        <div class="option-content">
                            <div class="option-title">POE Module</div>
                            <div class="option-description">Power over Ethernet module</div>
                        </div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="power" value="pwr">
                        <div class="option-content">
                            <div class="option-title">PWR Module</div>
                            <div class="option-description">External power module</div>
                        </div>
                    </label>
                </div>
                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                    <button class="btn btn-primary btn-next" onclick="nextStep()" disabled>Next</button>
                </div>
            </div>

            <!-- Step 3: Expansion Modules -->
            <div class="wizard-step" id="step-3">
                <h2>Step 3: Add Expansion Modules</h2>
                
                <!-- AirIQ Module -->
                <div class="module-section">
                    <h3>AirIQ Module</h3>
                    <div class="option-grid">
                        <label class="option-card">
                            <input type="radio" name="airiq" value="none" checked>
                            <div class="option-content">
                                <div class="option-title">None</div>
                                <div class="option-description">No AirIQ module</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="airiq" value="base">
                            <div class="option-content">
                                <div class="option-title">Base</div>
                                <div class="option-description">SGP41, SCD41, MiCS4514, BMP390</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="airiq" value="pro">
                            <div class="option-content">
                                <div class="option-title">Pro</div>
                                <div class="option-description">All Base + SEN0321, SPS30, SFA40</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Presence Module -->
                <div class="module-section">
                    <h3>Presence Module</h3>
                    <div class="option-grid">
                        <label class="option-card">
                            <input type="radio" name="presence" value="none" checked>
                            <div class="option-content">
                                <div class="option-title">None</div>
                                <div class="option-description">No Presence module</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="presence" value="base">
                            <div class="option-content">
                                <div class="option-title">Base</div>
                                <div class="option-description">SEN0609 mmWave sensor</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="presence" value="pro">
                            <div class="option-content">
                                <div class="option-title">Pro</div>
                                <div class="option-description">SEN0609 + LD2450 radar</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Comfort Module -->
                <div class="module-section">
                    <h3>Comfort Module</h3>
                    <div class="option-grid">
                        <label class="option-card">
                            <input type="radio" name="comfort" value="none" checked>
                            <div class="option-content">
                                <div class="option-title">None</div>
                                <div class="option-description">No Comfort module</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="comfort" value="base">
                            <div class="option-content">
                                <div class="option-title">Base</div>
                                <div class="option-description">SHT40 + LTR-303 sensors</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Fan Module (only for wall mount) -->
                <div class="module-section" id="fan-module-section">
                    <h3>Fan Module</h3>
                    <div class="option-grid">
                        <label class="option-card">
                            <input type="radio" name="fan" value="none" checked>
                            <div class="option-content">
                                <div class="option-title">None</div>
                                <div class="option-description">No Fan module</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="fan" value="pwm">
                            <div class="option-content">
                                <div class="option-title">PWM</div>
                                <div class="option-description">Variable speed fan control</div>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="fan" value="analog">
                            <div class="option-content">
                                <div class="option-title">Analog</div>
                                <div class="option-description">0-10V analog fan control</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                    <button class="btn btn-primary btn-next" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- Step 4: Review & Download -->
            <div class="wizard-step" id="step-4">
                <h2>Step 4: Review & Download</h2>
                
                <div class="configuration-summary">
                    <h3>Your Configuration</h3>
                    <div id="config-summary">
                        <!-- Summary will be populated by JavaScript -->
                    </div>
                </div>

                <div class="firmware-section">
                    <h3>Compatible Firmware</h3>
                    <div id="compatible-firmware">
                        <!-- Compatible firmware will be shown here -->
                    </div>
                </div>

                <div class="wizard-actions">
                    <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                    <button class="btn btn-primary" id="download-btn" onclick="downloadFirmware()" disabled>Download Firmware</button>
                </div>
            </div>
        </div>

        <div class="browser-check">
            <div class="browser-warning" id="browser-warning" style="display: none;">
                <h3>⚠️ Browser Not Supported</h3>
                <p>This installer requires Chrome or Edge browser with Web Serial API support.</p>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 4;
        const defaultConfiguration = {
            mounting: null,
            power: null,
            airiq: 'none',
            presence: 'none',
            comfort: 'none',
            fan: 'none'
        };
        const configuration = { ...defaultConfiguration };
        const allowedOptions = {
            mounting: ['wall', 'ceiling'],
            power: ['usb', 'poe', 'pwr'],
            airiq: ['none', 'base', 'pro'],
            presence: ['none', 'base', 'pro'],
            comfort: ['none', 'base'],
            fan: ['none', 'pwm', 'analog']
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check browser compatibility
            if (!navigator.serial) {
                document.getElementById('browser-warning').style.display = 'block';
            }

            // Add event listeners
            document.querySelectorAll('input[name="mounting"]').forEach(input => {
                input.addEventListener('change', handleMountingChange);
            });

            document.querySelectorAll('input[name="power"]').forEach(input => {
                input.addEventListener('change', handlePowerChange);
            });

            document.querySelectorAll('input[name="airiq"]').forEach(input => {
                input.addEventListener('change', updateConfiguration);
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', updateConfiguration);
            });

            document.querySelectorAll('input[name="presence"]').forEach(input => {
                input.addEventListener('change', updateConfiguration);
            });

            document.querySelectorAll('input[name="comfort"]').forEach(input => {
                input.addEventListener('change', updateConfiguration);
            });

            document.querySelectorAll('input[name="fan"]').forEach(input => {
                input.addEventListener('change', updateConfiguration);
            });

            initializeFromUrl();
        });

        function handleMountingChange(e) {
            configuration.mounting = e.target.value;
            document.querySelector('#step-1 .btn-next').disabled = false;

            // Show/hide fan module based on mounting type
            updateFanModuleVisibility();

            updateConfiguration({ skipUrlUpdate: true });
            updateUrlFromConfiguration();
        }

        function handlePowerChange(e) {
            configuration.power = e.target.value;
            document.querySelector('#step-2 .btn-next').disabled = false;
            updateUrlFromConfiguration();
        }

        function updateFanModuleVisibility() {
            const fanSection = document.getElementById('fan-module-section');
            if (configuration.mounting === 'ceiling') {
                fanSection.style.display = 'none';
                // Reset fan selection if ceiling mount
                document.querySelector('input[name="fan"][value="none"]').checked = true;
                configuration.fan = 'none';
            } else {
                fanSection.style.display = 'block';
            }
        }

        function updateConfiguration(options = {}) {
            // Update AirIQ
            const airiqValue = document.querySelector('input[name="airiq"]:checked')?.value || 'none';
            configuration.airiq = airiqValue;

            // Update Presence module
            configuration.presence = document.querySelector('input[name="presence"]:checked')?.value || 'none';

            // Update Comfort module
            configuration.comfort = document.querySelector('input[name="comfort"]:checked')?.value || 'none';

            // Update Fan module (only if wall mount)
            if (configuration.mounting === 'wall') {
                configuration.fan = document.querySelector('input[name="fan"]:checked')?.value || 'none';
            }

            if (!options.skipUrlUpdate) {
                updateUrlFromConfiguration();
            }
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                setStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                setStep(currentStep - 1);
            }
        }

        function setStep(targetStep, { skipUrlUpdate = false } = {}) {
            if (targetStep < 1 || targetStep > totalSteps) {
                return;
            }

            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                const progressElement = document.querySelector(`.progress-step[data-step="${i}"]`);

                if (i === targetStep) {
                    stepElement.classList.add('active');
                    progressElement.classList.add('active');
                } else {
                    stepElement.classList.remove('active');
                    progressElement.classList.remove('active');
                }

                if (i < targetStep) {
                    progressElement.classList.add('completed');
                } else {
                    progressElement.classList.remove('completed');
                }
            }

            currentStep = targetStep;

            if (currentStep === 3) {
                updateFanModuleVisibility();
            }

            if (currentStep === 4) {
                updateSummary();
                findCompatibleFirmware();
            }

            if (!skipUrlUpdate) {
                updateUrlFromConfiguration();
            }
        }

        function updateSummary() {
            updateConfiguration({ skipUrlUpdate: true });

            let summaryHtml = '<div class="summary-grid">';
            
            // Mounting
            summaryHtml += `
                <div class="summary-item">
                    <div class="summary-label">Mounting Type:</div>
                    <div class="summary-value">${configuration.mounting ? configuration.mounting.charAt(0).toUpperCase() + configuration.mounting.slice(1) : 'Not selected'}</div>
                </div>
            `;
            
            // Power
            summaryHtml += `
                <div class="summary-item">
                    <div class="summary-label">Power Option:</div>
                    <div class="summary-value">${configuration.power ? configuration.power.toUpperCase() : 'Not selected'}</div>
                </div>
            `;
            
            // AirIQ
            if (configuration.airiq !== 'none') {
                const airiqSensors = {
                    'base': ['SGP41', 'SCD41', 'MiCS4514', 'BMP390'],
                    'pro': ['SGP41', 'SCD41', 'MiCS4514', 'BMP390', 'SEN0321', 'SPS30', 'SFA40']
                };
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-label">AirIQ Module:</div>
                        <div class="summary-value">${configuration.airiq.charAt(0).toUpperCase() + configuration.airiq.slice(1)}</div>
                        <div class="summary-sensors">Includes: ${airiqSensors[configuration.airiq].join(', ')}</div>
                    </div>
                `;
            }
            
            // Presence
            if (configuration.presence !== 'none') {
                const presenceSensors = {
                    'base': ['SEN0609 mmWave sensor'],
                    'pro': ['SEN0609 mmWave sensor', 'LD2450 24GHz radar']
                };
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-label">Presence Module:</div>
                        <div class="summary-value">${configuration.presence.charAt(0).toUpperCase() + configuration.presence.slice(1)}</div>
                        <div class="summary-sensors">Includes: ${presenceSensors[configuration.presence].join(', ')}</div>
                    </div>
                `;
            }
            
            // Comfort
            if (configuration.comfort !== 'none') {
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-label">Comfort Module:</div>
                        <div class="summary-value">${configuration.comfort.charAt(0).toUpperCase() + configuration.comfort.slice(1)}</div>
                        <div class="summary-sensors">Includes: SHT40 (Temperature/Humidity), LTR-303 (Light)</div>
                    </div>
                `;
            }
            
            // Fan
            if (configuration.fan !== 'none') {
                const fanTypes = {
                    'pwm': 'Variable speed fan control via PWM',
                    'analog': '0-10V analog fan control'
                };
                summaryHtml += `
                    <div class="summary-item">
                        <div class="summary-label">Fan Module:</div>
                        <div class="summary-value">${configuration.fan.toUpperCase()}</div>
                        <div class="summary-sensors">${fanTypes[configuration.fan]}</div>
                    </div>
                `;
            }
            
            summaryHtml += '</div>';
            document.getElementById('config-summary').innerHTML = summaryHtml;
        }

        async function findCompatibleFirmware() {
            // Generate firmware filename based on configuration
            let configString = '';
            
            // Add mounting type
            configString += `${configuration.mounting.charAt(0).toUpperCase() + configuration.mounting.slice(1)}`;
            
            // Add power option
            configString += `-${configuration.power.toUpperCase()}`;
            
            // Add modules
            if (configuration.airiq !== 'none') {
                configString += `-AirIQ${configuration.airiq.charAt(0).toUpperCase() + configuration.airiq.slice(1)}`;
            }
            
            if (configuration.presence !== 'none') {
                configString += `-Presence${configuration.presence.charAt(0).toUpperCase() + configuration.presence.slice(1)}`;
            }
            
            if (configuration.comfort !== 'none') {
                configString += `-Comfort${configuration.comfort.charAt(0).toUpperCase() + configuration.comfort.slice(1)}`;
            }
            
            if (configuration.fan !== 'none') {
                configString += `-Fan${configuration.fan.toUpperCase()}`;
            }
            
            // Load manifest to check if firmware exists
            try {
                const response = await fetch('manifest.json');
                const manifest = await response.json();
                
                // Find matching firmware in manifest
                let matchingFirmware = null;
                for (const build of manifest.builds) {
                    // Check if this build matches our configuration
                    if (build.config_string === configString) {
                        matchingFirmware = build;
                        break;
                    }
                }
                
                if (matchingFirmware) {
                    // Store firmware info globally
                    window.currentFirmware = matchingFirmware;
                    window.currentConfigString = configString;
                    
                    // Firmware exists - show install option
                    const firmwareHtml = `
                        <div class="firmware-item">
                            <div class="firmware-info">
                                <div class="firmware-name">Sense360-${configString}-v${matchingFirmware.version}-${matchingFirmware.channel}.bin</div>
                                <div class="firmware-details">
                                    <span class="firmware-size">${(matchingFirmware.file_size / 1024).toFixed(1)} KB</span>
                                    <span class="firmware-date">${new Date(matchingFirmware.build_date).toLocaleDateString()}</span>
                                    <a href="#" class="release-notes-link" onclick="toggleReleaseNotes(event)">View Release Notes</a>
                                </div>
                            </div>
                            <esp-web-install-button manifest="firmware-${manifest.builds.indexOf(matchingFirmware)}.json">
                                <button slot="activate" class="btn btn-primary">
                                    Install Firmware
                                </button>
                            </esp-web-install-button>
                        </div>
                        <div class="release-notes-section" id="release-notes" style="display: none;">
                            <div class="release-notes-content">
                                <div class="loading">Loading release notes...</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('compatible-firmware').innerHTML = firmwareHtml;
                    document.getElementById('download-btn').disabled = false;
                } else {
                    // Firmware doesn't exist - show message
                    const notAvailableHtml = `
                        <div class="firmware-not-available">
                            <h4>Firmware Not Available</h4>
                            <p>The firmware for this configuration has not been built yet:</p>
                            <p class="config-string">Sense360-${configString}-v1.0.0-stable.bin</p>
                            <p class="help-text">Please contact support or check back later for this specific configuration.</p>
                        </div>
                    `;
                    document.getElementById('compatible-firmware').innerHTML = notAvailableHtml;
                    document.getElementById('download-btn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading manifest:', error);
                const errorHtml = `
                    <div class="firmware-error">
                        <h4>Error Loading Firmware</h4>
                        <p>Unable to check firmware availability. Please try again later.</p>
                    </div>
                `;
                document.getElementById('compatible-firmware').innerHTML = errorHtml;
                document.getElementById('download-btn').disabled = true;
            }
        }
        
        async function toggleReleaseNotes(event) {
            event.preventDefault();
            const notesSection = document.getElementById('release-notes');
            const link = event.target;
            
            if (notesSection.style.display === 'none') {
                notesSection.style.display = 'block';
                link.textContent = 'Hide Release Notes';
                
                // Load release notes if not already loaded
                if (notesSection.querySelector('.loading')) {
                    await loadReleaseNotes();
                }
            } else {
                notesSection.style.display = 'none';
                link.textContent = 'View Release Notes';
            }
        }
        
        async function loadReleaseNotes() {
            const notesSection = document.getElementById('release-notes');
            const configString = window.currentConfigString;
            const firmware = window.currentFirmware;
            
            try {
                // Try to load release notes file
                const notesPath = `firmware/configurations/Sense360-${configString}-v${firmware.version}-${firmware.channel}.md`;
                const response = await fetch(notesPath);
                
                if (response.ok) {
                    const markdown = await response.text();
                    // Better markdown to HTML conversion
                    let html = '';
                    const lines = markdown.split('\n');
                    let inList = false;
                    let inParagraph = false;
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        // Close paragraph if needed
                        if (inParagraph && (line === '' || line.match(/^#/) || line.match(/^-/))) {
                            html += '</p>';
                            inParagraph = false;
                        }
                        
                        // Close list if needed
                        if (inList && !line.match(/^-/)) {
                            html += '</ul>';
                            inList = false;
                        }
                        
                        // Headers
                        if (line.match(/^# /)) {
                            html += `<h2>${line.substring(2)}</h2>`;
                        } else if (line.match(/^## /)) {
                            html += `<h3>${line.substring(3)}</h3>`;
                        } else if (line.match(/^### /)) {
                            html += `<h4>${line.substring(4)}</h4>`;
                        }
                        // List items
                        else if (line.match(/^- /)) {
                            if (!inList) {
                                html += '<ul>';
                                inList = true;
                            }
                            html += `<li>${line.substring(2)}</li>`;
                        }
                        // Regular text
                        else if (line !== '') {
                            if (!inParagraph) {
                                html += '<p>';
                                inParagraph = true;
                            }
                            html += line + ' ';
                        }
                    }
                    
                    // Close any open tags
                    if (inParagraph) html += '</p>';
                    if (inList) html += '</ul>';
                    
                    notesSection.querySelector('.release-notes-content').innerHTML = html;
                } else {
                    notesSection.querySelector('.release-notes-content').innerHTML = `
                        <p class="no-notes">No release notes available for this firmware version.</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading release notes:', error);
                notesSection.querySelector('.release-notes-content').innerHTML = `
                    <p class="error">Unable to load release notes.</p>
                `;
            }
        }
        
        function downloadFirmware() {
            if (window.currentFirmware && window.currentConfigString) {
                const firmware = window.currentFirmware;
                const configString = window.currentConfigString;
                const firmwarePath = firmware.parts[0].path;
                
                // Create a link element and trigger download
                const link = document.createElement('a');
                link.href = firmwarePath;
                link.download = `Sense360-${configString}-v${firmware.version}-${firmware.channel}.bin`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function initializeFromUrl() {
            const { parsedConfig, providedKeys, parsedStep } = parseConfigurationFromLocation();

            applyConfiguration(parsedConfig);

            const maxStep = getMaxReachableStep();
            let targetStep;

            if (parsedStep) {
                targetStep = Math.min(parsedStep, maxStep);
            } else if (!configuration.mounting) {
                targetStep = 1;
            } else if (!configuration.power) {
                targetStep = 2;
            } else if (['airiq', 'presence', 'comfort', 'fan'].some(key => providedKeys.has(key))) {
                targetStep = Math.min(4, maxStep);
            } else {
                targetStep = Math.min(3, maxStep);
            }

            setStep(targetStep, { skipUrlUpdate: true });
        }

        function applyConfiguration(initialConfig) {
            Object.assign(configuration, defaultConfiguration, initialConfig);

            if (configuration.mounting) {
                const mountingInput = document.querySelector(`input[name="mounting"][value="${configuration.mounting}"]`);
                if (mountingInput) {
                    mountingInput.checked = true;
                    document.querySelector('#step-1 .btn-next').disabled = false;
                }
            } else {
                document.querySelector('#step-1 .btn-next').disabled = true;
            }

            if (configuration.power) {
                const powerInput = document.querySelector(`input[name="power"][value="${configuration.power}"]`);
                if (powerInput) {
                    powerInput.checked = true;
                    document.querySelector('#step-2 .btn-next').disabled = false;
                }
            } else {
                document.querySelector('#step-2 .btn-next').disabled = true;
            }

            ['airiq', 'presence', 'comfort', 'fan'].forEach(key => {
                const value = configuration[key];
                const input = document.querySelector(`input[name="${key}"][value="${value}"]`);
                if (input) {
                    input.checked = true;
                }
            });

            updateFanModuleVisibility();
            updateConfiguration({ skipUrlUpdate: true });
        }

        function getMaxReachableStep() {
            if (!configuration.mounting) {
                return 1;
            }

            if (!configuration.power) {
                return 2;
            }

            return 4;
        }

        function parseConfigurationFromLocation() {
            const combinedParams = new URLSearchParams();
            const searchParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.startsWith('#') ? window.location.hash.substring(1) : window.location.hash;
            const hashParams = new URLSearchParams(hash);

            hashParams.forEach((value, key) => {
                combinedParams.set(key, value);
            });

            searchParams.forEach((value, key) => {
                combinedParams.set(key, value);
            });

            const parsedConfig = { ...defaultConfiguration };
            const providedKeys = new Set();

            Object.keys(allowedOptions).forEach(key => {
                const value = combinedParams.get(key);
                if (value && allowedOptions[key].includes(value)) {
                    parsedConfig[key] = value;
                    providedKeys.add(key);
                }
            });

            let parsedStep = null;
            const stepValue = combinedParams.get('step');
            if (stepValue) {
                const numericStep = parseInt(stepValue, 10);
                if (!Number.isNaN(numericStep) && numericStep >= 1 && numericStep <= totalSteps) {
                    parsedStep = numericStep;
                }
            }

            return { parsedConfig, providedKeys, parsedStep };
        }

        function updateUrlFromConfiguration() {
            const params = new URLSearchParams();

            if (configuration.mounting) {
                params.set('mounting', configuration.mounting);
            }

            if (configuration.power) {
                params.set('power', configuration.power);
            }

            params.set('airiq', configuration.airiq || 'none');
            params.set('presence', configuration.presence || 'none');
            params.set('comfort', configuration.comfort || 'none');

            if (configuration.mounting === 'wall') {
                params.set('fan', configuration.fan || 'none');
            } else {
                params.set('fan', 'none');
            }

            params.set('step', String(currentStep));

            const paramString = params.toString();
            const newUrl = paramString ? `${window.location.pathname}?${paramString}` : window.location.pathname;
            history.replaceState(null, '', newUrl);
        }
    </script>
</body>
</html>
