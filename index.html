<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sense360 Flash - ESP32 Firmware Flashing Tool</title>
    <link rel="stylesheet" href="css/modern-style.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">S3</div>
                <div>
                    <div class="logo-text">Sense360 Flash</div>
                    <div class="subtitle">ESP32 Firmware Flashing Tool</div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="header-btn">‚öôÔ∏è</a>
                <a href="#" class="header-btn">üìñ</a>
                <a href="#" class="header-btn">üîó</a>
            </div>
        </header>

        <div class="main-grid">
            <div class="left-panel">
                <!-- Device Connection Section -->
                <div class="section">
                    <h2 class="section-title">Device Connection</h2>
                    <div class="connection-status">
                        <div class="status-indicator" id="connectionStatus"></div>
                        <span class="status-text" id="connectionText">No device connected</span>
                    </div>
                    <p class="section-subtitle">Connect your ESP32-based Sense360 device via USB cable to begin flashing firmware.</p>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="connectBtn">
                            üîå Connect Device
                        </button>
                        <button class="btn btn-secondary" id="diagnosticsBtn">
                            üîß Test Diagnostics
                        </button>
                    </div>
                </div>

                <!-- Firmware Selection Section -->
                <div class="section">
                    <h2 class="section-title">Firmware Selection</h2>
                    <div class="firmware-grid">
                        <div class="firmware-option selected" data-firmware="factory">
                            <div class="firmware-header">
                                <div class="firmware-radio"></div>
                                <div class="firmware-name">Sense360 V2 v2.0.0</div>
                                <div class="firmware-tag">Factory</div>
                            </div>
                            <div class="firmware-description">
                                First factory firmware for Sense360 V2. Use for initial flashing or device recovery.
                            </div>
                        </div>
                        <div class="firmware-option" data-firmware="development">
                            <div class="firmware-header">
                                <div class="firmware-radio"></div>
                                <div class="firmware-name">Sense360 V2 v2.1.0-dev</div>
                                <div class="firmware-tag development">Development</div>
                            </div>
                            <div class="firmware-description">
                                Latest development build with enhanced features and bug fixes. Use for testing new capabilities.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flashing Process Section -->
                <div class="section">
                    <h2 class="section-title">Flashing Process</h2>
                    <div class="process-steps">
                        <div class="process-step">
                            <div class="step-number" id="step1">1</div>
                            <div class="step-content">
                                <div class="step-title">Device Connected</div>
                                <div class="step-description">ESP32 device detected and ready</div>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="step-number" id="step2">2</div>
                            <div class="step-content">
                                <div class="step-title">Firmware Selected</div>
                                <div class="step-description">Choose firmware version to install</div>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="step-number" id="step3">3</div>
                            <div class="step-content">
                                <div class="step-title">Flashing Complete</div>
                                <div class="step-description">Device will reboot automatically</div>
                            </div>
                        </div>
                    </div>

                    <div class="ready-status not-ready" id="readyStatus">
                        <div class="ready-icon">!</div>
                        <div class="ready-text">Missing: device connection and firmware selection.</div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-large btn-flash" id="flashBtn" disabled>
                            ‚ö° Flash Firmware
                        </button>
                        <button class="btn-large btn-erase" id="eraseBtn" disabled>
                            üóëÔ∏è Erase Flash
                        </button>
                    </div>
                    
                    <a href="#" class="serial-monitor-link" id="serialMonitorLink">
                        Open Serial Monitor
                    </a>
                </div>

                <!-- ESP Web Tools (temporarily visible for testing) -->
                <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 16px;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Debug: ESP Web Tools buttons</p>
                    <esp-web-install-button
                        id="factoryInstaller"
                        manifest="manifest.json">
                        Install Factory Firmware
                    </esp-web-install-button>
                    <esp-web-install-button
                        id="devInstaller"
                        manifest="manifest-dev.json">
                        Install Dev Firmware
                    </esp-web-install-button>
                </div>
            </div>

            <div class="right-panel">
                <!-- Connection Requirements -->
                <div class="info-card">
                    <h3>Connection Requirements</h3>
                    <div class="requirements-list">
                        <div class="requirement-item">
                            <div class="requirement-icon">‚úì</div>
                            <div>
                                <div class="requirement-text">Chrome, Edge, or Opera browser</div>
                                <div class="requirement-subtext">Web Serial API support required</div>
                            </div>
                        </div>
                        <div class="requirement-item">
                            <div class="requirement-icon">‚úì</div>
                            <div>
                                <div class="requirement-text">USB cable connected to device</div>
                                <div class="requirement-subtext">Data cable, not charging-only</div>
                            </div>
                        </div>
                        <div class="requirement-item">
                            <div class="requirement-icon">‚úì</div>
                            <div>
                                <div class="requirement-text">Device in bootloader mode</div>
                                <div class="requirement-subtext">Hold BOOT button while connecting</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Information -->
                <div class="info-card">
                    <h3>Project Information</h3>
                    <div class="project-links">
                        <div class="project-link">
                            <span class="project-link-text">Repository:</span>
                            <a href="#" class="project-link-value">GitHub</a>
                        </div>
                        <div class="project-link">
                            <span class="project-link-text">Documentation:</span>
                            <a href="#" class="project-link-value">Docs</a>
                        </div>
                        <div class="project-link">
                            <span class="project-link-text">Support:</span>
                            <a href="#" class="project-link-value">Forum</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFirmware = 'factory';
        let deviceConnected = false;

        // Firmware selection
        document.querySelectorAll('.firmware-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.firmware-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                selectedFirmware = option.dataset.firmware;
                updateUI();
            });
        });

        // Connect button
        document.getElementById('connectBtn').addEventListener('click', () => {
            try {
                const installer = selectedFirmware === 'factory' ? 
                    document.getElementById('factoryInstaller') : 
                    document.getElementById('devInstaller');
                
                console.log('Attempting to trigger installer:', installer);
                
                // Trigger ESP Web Tools by dispatching click event
                const clickEvent = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                });
                installer.dispatchEvent(clickEvent);
            } catch (error) {
                console.error('Connection failed:', error);
                alert('Failed to connect to device. Please ensure you are using Chrome/Edge browser.');
            }
        });

        // Flash button
        document.getElementById('flashBtn').addEventListener('click', () => {
            const installer = selectedFirmware === 'factory' ? 
                document.getElementById('factoryInstaller') : 
                document.getElementById('devInstaller');
            
            // Trigger ESP Web Tools by clicking the hidden button
            installer.click();
        });

        // Update UI based on state
        function updateUI() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const readyStatus = document.getElementById('readyStatus');
            const flashBtn = document.getElementById('flashBtn');
            const eraseBtn = document.getElementById('eraseBtn');

            // Update step indicators
            step2.classList.add('completed');
            
            // Update ready status
            if (deviceConnected) {
                step1.classList.add('completed');
                readyStatus.classList.remove('not-ready');
                readyStatus.querySelector('.ready-icon').textContent = '‚úì';
                readyStatus.querySelector('.ready-text').textContent = 'Ready to Flash';
                flashBtn.disabled = false;
                eraseBtn.disabled = false;
            } else {
                readyStatus.classList.add('not-ready');
                readyStatus.querySelector('.ready-icon').textContent = '!';
                readyStatus.querySelector('.ready-text').textContent = 'Missing: device connection.';
                flashBtn.disabled = true;
                eraseBtn.disabled = true;
            }
        }

        // Listen for ESP Web Tools events
        const factoryInstaller = document.getElementById('factoryInstaller');
        const devInstaller = document.getElementById('devInstaller');
        
        // Add event listeners to both installers
        [factoryInstaller, devInstaller].forEach(installer => {
            installer.addEventListener('state-changed', (event) => {
                const state = event.detail.state;
                
                if (state === 'connected') {
                    deviceConnected = true;
                    document.getElementById('connectionStatus').classList.add('connected');
                    document.getElementById('connectionText').textContent = 'Device connected';
                    updateUI();
                } else if (state === 'disconnected') {
                    deviceConnected = false;
                    document.getElementById('connectionStatus').classList.remove('connected');
                    document.getElementById('connectionText').textContent = 'No device connected';
                    updateUI();
                } else if (state === 'installing') {
                    document.getElementById('step3').classList.add('active');
                } else if (state === 'installed') {
                    document.getElementById('step3').classList.remove('active');
                    document.getElementById('step3').classList.add('completed');
                }
            });
        });

        // Initialize UI
        updateUI();

        // Debug: Check if ESP Web Tools loaded
        window.addEventListener('load', () => {
            console.log('ESP Web Tools loaded:', !!customElements.get('esp-web-install-button'));
            console.log('Factory installer:', document.getElementById('factoryInstaller'));
            console.log('Dev installer:', document.getElementById('devInstaller'));
        });
    </script>
</body>
</html>