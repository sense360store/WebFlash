<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sense360 ESP32 Installer</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Sense360 ESP32 Installer</h1>
            <p>Flash Sense360 v2.0.0 firmware to ESP32 devices</p>
        </header>

        <main>
            <div class="intro-section">
                <h2>Getting Started</h2>
                <p>Connect your ESP32 device to your computer using a USB cable. Make sure you're using Chrome or Edge browser with HTTPS enabled.</p>
                <p>This installer will flash the Sense360 v2.0.0 firmware to your ESP32 device. Click the "Install Sense360" button below to begin.</p>
            </div>

            <div class="install-section">
                <h2>Install Sense360 Firmware</h2>
                <div class="firmware-selection">
                    <h3>Select Firmware Variant</h3>
                    <p>Choose the firmware that matches your intended use case:</p>
                    
                    <div class="firmware-options">
                        <div class="firmware-option">
                            <input type="radio" id="fan" name="firmware" value="fan" checked>
                            <label for="fan">
                                <div class="option-header">
                                    <strong>Fan Control (PWM)</strong>
                                    <span class="version">v1.0.0 Stable</span>
                                </div>
                                <div class="option-description">
                                    Optimized for fan control applications with PWM output support. Compatible with ESP32-S3.
                                </div>
                                <div class="option-features">
                                    <span class="feature">PWM Control</span>
                                    <span class="feature">Wi-Fi Setup</span>
                                    <span class="feature">ESP32-S3</span>
                                </div>
                            </label>
                        </div>

                        <div class="firmware-option">
                            <input type="radio" id="airq" name="firmware" value="airq">
                            <label for="airq">
                                <div class="option-header">
                                    <strong>Air Quality (CO2)</strong>
                                    <span class="version">v1.0.0 Beta</span>
                                </div>
                                <div class="option-description">
                                    Advanced air quality monitoring with CO2 sensor integration. Compatible with ESP32 WROOM1.
                                </div>
                                <div class="option-features">
                                    <span class="feature">CO2 Sensors</span>
                                    <span class="feature">Wi-Fi Setup</span>
                                    <span class="feature">ESP32</span>
                                </div>
                            </label>
                        </div>

                        <div class="firmware-option">
                            <input type="radio" id="multi" name="firmware" value="multi">
                            <label for="multi">
                                <div class="option-header">
                                    <strong>Multi-Function</strong>
                                    <span class="version">v2.1.3 Stable</span>
                                </div>
                                <div class="option-description">
                                    Versatile firmware supporting multiple sensor types and control options. Compatible with ESP32-S3.
                                </div>
                                <div class="option-features">
                                    <span class="feature">Multi-Sensor</span>
                                    <span class="feature">Wi-Fi Setup</span>
                                    <span class="feature">ESP32-S3</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="install-container">
                    <esp-web-install-button manifest="./manifest.json" id="install-button">
                        <button type="button" class="btn-primary" slot="activate">Install Selected Firmware</button>
                        <span slot="not-allowed">
                            <div class="alert alert-danger">
                                <h3>‚ö†Ô∏è Not Allowed</h3>
                                <p>Flashing is only supported from localhost or from a secure (HTTPS) website.</p>
                            </div>
                        </span>
                        <span slot="notsupported">
                            <div class="alert alert-danger">
                                <h3>‚ö†Ô∏è Browser Not Supported</h3>
                                <p>ESP Web Tools requires Chrome or Edge browser. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility" target="_blank">Check browser compatibility</a></p>
                            </div>
                        </span>
                    </esp-web-install-button>
                </div>
            </div>

            <div class="features-section">
                <h2>Features</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <h3>üîå Easy Connection</h3>
                        <p>Connect ESP32 devices directly via USB using the Web Serial API</p>
                    </div>
                    <div class="feature-card">
                        <h3>‚ö° Fast Flashing</h3>
                        <p>Automatic chip detection and optimized firmware flashing</p>
                    </div>
                    <div class="feature-card">
                        <h3>üì± Wi-Fi Setup</h3>
                        <p>Configure Wi-Fi settings using Improv protocol after flashing</p>
                    </div>
                    <div class="feature-card">
                        <h3>üîç Serial Monitor</h3>
                        <p>Real-time serial output monitoring and command interface</p>
                    </div>
                </div>
            </div>

            <div class="troubleshooting-section">
                <h2>Troubleshooting</h2>
                <div class="troubleshooting-content">
                    <h3>Device Not Detected?</h3>
                    <ul>
                        <li>Make sure your ESP32 is connected via USB</li>
                        <li>Check that you're using Chrome or Edge browser</li>
                        <li>Verify you're accessing the site via HTTPS</li>
                        <li>Try a different USB cable or port</li>
                        <li>On Windows, ensure proper drivers are installed</li>
                    </ul>
                    
                    <h3>Flashing Failed?</h3>
                    <ul>
                        <li>Hold the BOOT button while connecting (if available)</li>
                        <li>Try resetting the device before flashing</li>
                        <li>Ensure no other applications are using the serial port</li>
                        <li>Check that the firmware file is compatible with your chip</li>
                    </ul>
                </div>
            </div>
        </main>

        <footer>
            <p>
                <a href="https://github.com/esphome/esp-web-tools" target="_blank">Powered by ESP Web Tools</a> | 
                <a href="https://github.com/your-repo/esp32-flasher" target="_blank">View Source</a>
            </p>
        </footer>
    </div>
    
    <script>
        // Handle firmware selection
        const firmwareOptions = document.querySelectorAll('input[name="firmware"]');
        const installButton = document.getElementById('install-button');
        
        const manifestMap = {
            'fan': './manifests/fan-manifest.json',
            'airq': './manifests/airq-manifest.json',
            'multi': './manifests/multi-manifest.json'
        };
        
        function updateManifest() {
            const selectedFirmware = document.querySelector('input[name="firmware"]:checked').value;
            const manifestPath = manifestMap[selectedFirmware];
            installButton.setAttribute('manifest', manifestPath);
        }
        
        // Add event listeners to radio buttons
        firmwareOptions.forEach(option => {
            option.addEventListener('change', updateManifest);
        });
        
        // Set initial manifest (fan firmware by default)
        updateManifest();
    </script>
</body>
</html>
